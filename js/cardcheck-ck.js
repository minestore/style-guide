/*!
 * Card Check
 * 
 * A credit card validator and type guesser 
 * 
 * This is the standalone version of CardCheck.
 * It uses the jQuery methods $.extend and $.inArray
 *  
 * For documentation, look in the package you downloaded or go to
 * http://eclarian.com/cardcheck/
 * 
 * NOTE: This is not open source software and you must purchase
 * a license to legally use.
 * 
 * @uses       jQuery
 * @author     Eclarian Dev Team <eclarian@eclarian.com>
 * @copyright  Eclarian LLC
 * @date       November 29, 2011
 * @updated    March 20, 2013
 * @version    2.0.0
 */(function(e,t){"use strict";if(e.CardCheck)return;var n={cardNumber:null,allowSpaces:!0,acceptedCards:["visa","mastercard","amex","diners","hipercard"],niceNames:{visa:"Visa",mastercard:"Mastercard",amex:"American Express",diners:"Diners Club",hipercard:"Hipercard"},regExpNumCheck:"^[0-9]+$",regExpApprox:{visa:"^4",mastercard:"^5[1-5]",amex:"^(34|37)",diners:"^(30|36|38|39)",hipercard:""},startNum:{visa:["4"],mastercard:["5"],amex:["3"],diners:["3"],hipercard:[""]},cardLength:{visa:[13,16],mastercard:[16],amex:[15],diners:[14],hipercard:[""]}},r=function(e){return Math.min.apply(Math,e)},i=function(e){return Math.max.apply(Math,e)},s=function(e){if(this instanceof s){this._callbacks={};this._settings={};return typeof e=="number"||typeof e=="string"?this.options().cardNumber(e):this.options(e)}return new s(e)};s.prototype={_cardNumber:null,_cardType:null,_isValid:undefined,_numCheck:null,cardNumber:function(e){if(typeof e=="undefined")return this._cardNumber;e=e.toString();this._settings.allowSpaces===!0&&(e=e.replace(/\s/g,""));if(this._cardNumber===e)return this;this._cardNumber=e;return this.evaluate()},cardType:function(e){return this._cardType?e?this._settings.niceNames[this._cardType]:this._cardType:null},niceName:function(e){return this._settings.niceNames[e]?this._settings.niceNames[e]:""},eachCard:function(e){for(var t=0;t<this._settings.acceptedCards.length;t++){var n=this._settings.acceptedCards[t],r=e(n);if(r===!1)return!1}return this},evaluate:function(){this._numCheck||(this._numCheck=new RegExp(this._settings.regExpNumCheck));if(!this._cardNumber)this._switchState(null);else if(!this._cardNumber.match(this._numCheck))this._switchState(!1);else{var e=this;this.eachCard(function(n){if(e._cardNumber.length===1&&n in e._settings.startNum){if(e._cardNumber==="3"||e._cardNumber==="6"){e._switchState(null);return!0}if(t.inArray(e._cardNumber,e._settings.startNum[n])!==-1){e._switchState(null,n);return!1}}else if(e._cardNumber.length===2&&(e._cardNumber==="60"||e._cardNumber==="65")){e._switchState(null,"discover");return!1}var s,o=!1,u=!1,a=!1;if(n in e._settings.cardLength&&t.inArray(e._cardNumber.length,e._settings.cardLength[n])!==-1)o=!0;else if(e._cardNumber.length>=i(e._settings.cardLength[n])){o=!0;u=!0;a=e._cardNumber.length>i(e._settings.cardLength[n])}else e._isValid===!0&&e._delayState(null);if(n in e._settings.regExpApprox){s=new RegExp(e._settings.regExpApprox[n]);if(e._cardNumber.match(s)){if(o===!1){e._switchState(null,n);return!1}e.luhnCheck(e._cardNumber)===!0&&!a?e._switchState(!0,n):u?e._switchState(!1,n):e._cardNumber.length<r(e._settings.cardLength[n])&&e._switchState(null,n);return!1}}})}return this},luhnCheck:function(e){var t=[[0,2,4,6,8,1,3,5,7,9],[0,1,2,3,4,5,6,7,8,9]],n=0;e.replace(/\D+/g,"").replace(/[\d]/g,function(e,r,i){n+=t[i.length-r&1][parseInt(e,10)]});return n%10===0&&n>0},options:function(e){var r,i=!1;e=e||{};if(e.cardNumber){r=e.cardNumber;i=!0;delete e.cardNumber}this._settings=t.extend({},n,e);i&&this.cardNumber(r);return this},onToggle:function(e){return this._setCallback("onToggle",e)},onValid:function(e){return this._setCallback("onValid",e)},onValidation:function(e){return this.onValid(e)},onInvalid:function(e){return this._setCallback("onInvalid",e)},onError:function(e){return this.onInvalid(e)},onUnknown:function(e){return this._setCallback("onUnknown",e)},onGuess:function(e){return typeof e!="function"?this:this.onUnknown(function(t){t&&e(t)})},onReset:function(e){return typeof e!="function"?this:this.onUnknown(function(t){t||e()})},onCardChange:function(e){return this._setCallback("onCardChange",e)},onTypeUpdate:function(e){return this.onCardChange(e)},_setCallback:function(e,t){if(typeof t!="function")return this;this._callbacks[e]||(this._callbacks[e]=[]);this._callbacks[e].push(t);return this},_runCallbacks:function(e,t,n){var r=this._callbacks[e];if(!r||r.length===0)return this;t=t||null;n=n||this;for(var i=0;i<r.length;i++)r[i].apply(n,t);return this},_setCardType:function(e){this._cardType!==e&&this._runCallbacks("onCardChange",[e,this.niceName(e)]);this._cardType=e;return this},_delayState:function(e,t){var n=this;setTimeout(function(){e!==n._isValid&&n._switchState(e,t)},50);return this},_switchState:function(e,t){typeof t=="undefined"&&(t=null);if(e===this._isValid&&this._cardType===t)return this;this._setCardType(t);this._isValid=e;e===!0?this._runCallbacks("onValid",[t,this.niceName(t)]):e===!1?this._runCallbacks("onInvalid"):e===null&&this._runCallbacks("onUnknown",[t,this.niceName(t)]);this._runCallbacks("onToggle",[e,t,this.niceName(t)]);return this}};e.CardCheck=s;var o=function(e,n,r){typeof r.enableIcons!="undefined"&&r.enableIcons!==!0&&(this.disabled=!0);this.$el=e;this.uniqueClass=n;this.acceptedCards=r.acceptedCards;this.iconLocation=r.iconLocation?t(r.iconLocation):e.parent();this.iconDir=r.iconDir?r.iconDir:"../../img/cards/";this.iconExt=r.iconExt?r.iconExt:"png";this.iconClass=r.iconClass?r.iconClass:"card-icons";this.createIcons();this.icons=t("."+this.iconClass+this.uniqueClass);return this};o.prototype={createIcons:function(){if(this.disabled)return this;var e=this;t.each(e.acceptedCards,function(n,r){t(".payments").append(t("<img>").attr("id","card-"+r+e.uniqueClass).attr("src",e.iconDir+r+"."+e.iconExt).addClass(e.iconClass+e.uniqueClass))});return this},showOnly:function(e){if(this.disabled)return this;var t=this;this.hideExcept(e,function(e){t.showCard(e)});return this},showCard:function(e){t("#card-"+e+this.uniqueClass).css("opacity",1);return this},showAll:function(){if(this.disabled)return this;this.icons.css("opacity",1);return this},hideExcept:function(e,t){if(this.disabled)return this;t=t||function(){};this.icons.not("#card-"+e+this.uniqueClass).fadeTo("fast",.2,function(){t(e)});return this},hideAll:function(){if(this.disabled)return this;this.icons.fadeTo("fast",.2);return this}};t.cardcheck=function(n,r){e.CardCheckInstances||(e.CardCheckInstances={});if(typeof n=="object"&&"input"in n){r=n;n=r.input}r=r||{};var i=t(n),u=new s(r),a=Math.floor(Math.random()*1e3),f=new o(i,a,u._settings),l=function(e){this.event=e;this.run=function(e){i.trigger("cc:"+this.event,e)};return this},c=["onToggle","onValid","onValidation","onInvalid","onError","onUnknown","onGuess","onReset","onCardChange","onTypeUpdate"];i.addClass("cardcheck-instance-"+a).data("cardcheck-instance",a);e.CardCheckInstances[a]||(e.CardCheckInstances[a]=u);for(var h=0;h<c.length;h++)(function(e){if(u[e]){var t=new l(e);u[e](function(){t.run(arguments)});r[e]&&u[e](r[e])}})(c[h]);u.onInvalid(function(){f.hideAll()}).onValid(function(e){f.showOnly(e)}).onGuess(function(e){f.showOnly(e)}).onReset(function(){f.showAll()});i.on("keyup.cardcheck change.cardcheck",function(){u.cardNumber(t(this).val())});i.trigger("cc:initialized",[f]);return i};t.fn.cardcheck=function(n){if(t(this).data("cardcheck-instance")){var r=e.CardCheckInstances[t(this).data("cardcheck-instance")];if(n==="instance")return r;if(n==="evaluate"){r.evaluate();return t(this)}}else if(n==="instance"||n==="evaluate")return t(this);return this.each(function(){if(t(this).data("cardcheck")!==!0)return t.cardcheck(this,n).data("cardcheck",!0)})}})(window,jQuery);